<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GardenManager Pro</title>
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
        header { background-color: #2e7d32; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.25rem; }
        .menu-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        main { padding: 1rem; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { display: block; width: 100%; padding: 0.75rem; margin: 0.5rem 0; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background 0.2s; }
        .btn-primary { background-color: #2e7d32; color: white; }
        .btn-primary:hover { background-color: #1b5e20; }
        .btn-secondary { background-color: #e8f5e9; color: #2e7d32; }
        .btn-secondary:hover { background-color: #c8e6c9; }
        
        /* New Dashboard Styles */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .stat-card { background: white; padding: 1rem; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-number { font-size: 1.5rem; font-weight: bold; color: #2e7d32; }
        .stat-label { font-size: 0.875rem; color: #666; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .list-group { list-style: none; padding: 0; margin: 0; }
        .list-item { border-bottom: 1px solid #eee; padding: 0.75rem 0; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
        .item-main { font-weight: 500; }
        .item-sub { font-size: 0.85rem; color: #666; }
        .status-badge { padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; }
        .status-pending { background: #fff3e0; color: #e65100; }
        .status-completed { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>
    <header>
        <h1>GardenManager Pro</h1>
        <button class="menu-btn" onclick="handleLogout()" style="font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.5); padding: 0.25rem 0.75rem; border-radius: 4px;">Log Out</button>
    </header>
    <main>
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="todayJobsCount">0</div>
                <div class="stat-label">Jobs Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalClientsCount">0</div>
                <div class="stat-label">Total Clients</div>
            </div>
        </div>

        <div class="card">
            <h3>Quick Actions</h3>
            <div class="action-grid">
                <button class="btn btn-primary" onclick="window.location.href='scan.html'">üì± Scan Client</button>
                <button class="btn btn-primary" onclick="window.location.href='new-job.html'">üõ†Ô∏è New Job</button>
                <button class="btn btn-secondary" onclick="messageAll()">üì¢ Message All</button>
                <button class="btn btn-secondary" onclick="viewCalendar()">üìÖ Calendar</button>
            </div>
        </div>

        <div class="card">
            <h3>Today's Jobs</h3>
            <ul class="list-group" id="jobsList">
                <li class="list-item" style="justify-content: center; color: #666;">Loading...</li>
            </ul>
        </div>

        <div class="card">
            <h3>Recent Clients</h3>
            <ul class="list-group" id="clientsList">
                <li class="list-item" style="justify-content: center; color: #666;">Loading...</li>
            </ul>
        </div>
    </main>
    <script>
        // Initialize Supabase client using variables from config.js
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function initApp() {
            console.log('Welcome to GardenManager Pro!');
            loadDashboardData();
        }

        async function loadDashboardData() {
            const { data, error } = await sb.auth.getSession();
            
            if (error || !data.session) {
                console.log('Not logged in or connection error');
                window.location.href = '../global/login/login.html';
                return;
            }

            const user = data.session.user;
            console.log('‚úÖ Supabase Connected as ' + user.email);

            // 1. Get Stats (Clients count)
            const { count: clientCount } = await sb
                .from('pairings')
                .select('*', { count: 'exact', head: true })
                .eq('contractor_id', user.id);
            
            document.getElementById('totalClientsCount').innerText = clientCount || 0;

            // 2. Get Today's Jobs
            const today = new Date().toISOString().split('T')[0];
            const { data: jobs } = await sb
                .from('jobs')
                .select(`*, pairings ( client_name )`)
                .eq('contractor_id', user.id)
                .eq('scheduled_date', today)
                .order('scheduled_time');

            const jobsList = document.getElementById('jobsList');
            jobsList.innerHTML = '';

            if (jobs && jobs.length > 0) {
                document.getElementById('todayJobsCount').innerText = jobs.length;
                jobs.forEach(job => {
                    const clientName = job.pairings?.client_name || 'Unknown Client';
                    const time = job.scheduled_time ? job.scheduled_time.substring(0, 5) : '--:--';
                    
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <div>
                            <div class="item-main">${clientName}</div>
                            <div class="item-sub">${time} ‚Ä¢ ${job.service}</div>
                        </div>
                        <span class="status-badge status-${job.status}">${job.status}</span>
                    `;
                    jobsList.appendChild(li);
                });
            } else {
                document.getElementById('todayJobsCount').innerText = '0';
                jobsList.innerHTML = '<li class="list-item" style="justify-content: center;"><a href="new-job.html" style="color: #2e7d32; text-decoration: none; font-weight: 500;">No jobs scheduled today. Create one!</a></li>';
            }

            // 3. Get Recent Clients
            const { data: clients } = await sb
                .from('pairings')
                .select('*')
                .eq('contractor_id', user.id)
                .order('paired_at', { ascending: false })
                .limit(5);

            const clientsList = document.getElementById('clientsList');
            clientsList.innerHTML = '';

            if (clients && clients.length > 0) {
                clients.forEach(client => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <div>
                            <div class="item-main">${client.client_name}</div>
                            <div class="item-sub">${client.garden_details || 'No details'}</div>
                        </div>
                    `;
                    clientsList.appendChild(li);
                });
            } else {
                clientsList.innerHTML = '<li class="list-item" style="justify-content: center;"><a href="scan.html" style="color: #2e7d32; text-decoration: none; font-weight: 500;">No clients yet. Scan one!</a></li>';
            }
        }

        function messageAll() {
            alert('üì¢ Bulk messaging tool would open here');
        }

        function viewCalendar() {
            alert('üìÖ Calendar view would open here');
        }

        async function handleLogout() {
            await sb.auth.signOut();
            window.location.href = '../global/login/login.html';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initApp);

        // Service Worker for PWA
        // Only register service worker if supported and not running on file:// protocol
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>